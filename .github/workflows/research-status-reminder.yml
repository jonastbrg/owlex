name: Research Status Reminder

on:
  schedule:
    # 9 AM UTC daily
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-staleness:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./research
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check last update times
        id: check
        run: |
          echo "## Research Dashboard Staleness Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for status_file in */STATUS.md; do
            if [ -f "$status_file" ]; then
              project=$(dirname "$status_file")
              last_modified=$(git log -1 --format="%ci" -- "$status_file" 2>/dev/null || echo "never")
              days_ago=$(( ($(date +%s) - $(git log -1 --format="%ct" -- "$status_file" 2>/dev/null || echo 0)) / 86400 ))

              if [ "$days_ago" -gt 7 ]; then
                echo "- :warning: **$project**: Last updated $days_ago days ago" >> $GITHUB_STEP_SUMMARY
                echo "STALE=true" >> $GITHUB_OUTPUT
              else
                echo "- :white_check_mark: **$project**: Updated $days_ago days ago" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Create reminder issue if stale
        if: steps.check.outputs.STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'reminder'
            });

            // Don't create duplicate reminder issues
            const hasOpenReminder = issues.some(i => i.title.includes('Research Status'));
            if (hasOpenReminder) {
              console.log('Reminder issue already exists');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Research Status Update Reminder',
              body: 'One or more research STATUS.md files have not been updated in over 7 days.\n\nPlease review and update project statuses in the `research/` directory.',
              labels: ['reminder', 'research']
            });
